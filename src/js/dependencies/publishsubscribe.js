/**
*  PublishSubscribe
*  A simple publish-subscribe implementation for PHP, Python, Node/JS
*
*  @version: 0.4.1
*  https://github.com/foo123/PublishSubscribe
*
**/
!function(t,s,n){"use strict";var e;"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(t.EXPORTED_SYMBOLS=[s])&&(t[s]=n.call(t)):"object"==typeof module&&module.exports?module.exports=n.call(t):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(s)?define(s,["require","exports","module"],function(){return n.call(t)}):s in t||(t[s]=e=n.call(t))&&"function"==typeof define&&define.amd&&define(function(){return e})}(this,"PublishSubscribe",function(){"use strict";function t(t){if(t)for(var s in t)t[O](s)&&(this[s]=t[s])}function s(s,n,e,i,o){var p=this;p.target=s,p.topic=n?[].concat(n):[],e&&(p.originalTopic=[].concat(e)),p.tags=i?[].concat(i):[],p.namespaces=o?[].concat(o):[],p.data=new t,p.timestamp=T(),p._propagates=!0,p._stopped=!1,p._aborted=!1}function n(){return{notopics:{notags:{namespaces:{},list:[],oneOffs:0},tags:{}},topics:{}}}function e(t){return t.length>0}function i(t,s){var n,i,o,p;return s=String(s),n=s.indexOf(t[2]),i=s.indexOf(t[1]),n>-1?(p=s.slice(n).split(t[2]).filter(e).sort(),s=s.slice(0,n)):p=[],i>-1?(o=s.slice(i).split(t[1]).filter(e).sort(),s=s.slice(0,i)):o=[],s=s.split(t[0]).filter(e),[s,o,p]}function o(t,s){var n,e,o,p,l,a,r,c,u=[],f=[];for(s=i(t,s),n=s[2],e=s[1],s=s[0],o=s.length;o;)u.push(s.join(j)),s.pop(),o--;if(o=e.length,o>1){for(c=1<<o,p=c-1;p>=1;p--){for(r=[],l=0,a=1;o>l;l++,a=1<<l)p!==a&&p&a&&r.push(e[l]);r.length&&f.push(r.join(w))}f=f.concat(e)}else o&&f.push(e[0]);return[u.length?u[0]:"",u,f,n]}function p(t,s,n){var e,i;for(e=0;n>e;e++)i="ns_"+s[e],t[O](i)?t[i]++:t[i]=1}function l(t,s,n){var e,i;for(e=0;n>e;e++)i="ns_"+s[e],t[O](i)&&(t[i]--,t[i]<=0&&delete t[i])}function a(t,s,n){var e,i;for(e=0;n>e;e++)if(i="ns_"+s[e],!t[O](i)||0>=t[i])return!1;return!0}function r(t,s,n,e,i,o){var p=n?"tp_"+n:!1,l=e?"tg_"+e:!1;if(p&&t.topics[O](p)){if(l&&t.topics[p].tags[O](l)){if(t.topics[p].tags[l].list.length&&(0>=o||a(t.topics[p].tags[l].namespaces,i,o)))return s.push([n,e,o>0,t.topics[p].tags[l]]),!0}else if(t.topics[p].notags.list.length&&(0>=o||a(t.topics[p].notags.namespaces,i,o)))return s.push([n,null,o>0,t.topics[p].notags]),!0}else if(l&&t.notopics.tags[O](l)){if(t.notopics.tags[l].list.length&&(0>=o||a(t.notopics.tags[l].namespaces,i,o)))return s.push([null,e,o>0,t.notopics.tags[l]]),!0}else if(t.notopics.notags.list.length&&(0>=o||a(t.notopics.notags.namespaces,i,o)))return s.push([null,null,!0,t.notopics.notags]),!0;return!1}function c(t,s,n){var e,i,p,l,a,c,u=o(t,n),f=u[1],g=u[2],h=u[3],b=u[0],_=[];if(a=g.length,c=h.length,e=f.length)for(;e;){if(i=f[0],s.topics[O]("tp_"+i))if(a>0)for(l=0;a>l;l++)p=g[l],r(s,_,i,p,h,c);else r(s,_,i,null,h,c);f.shift(),e--}if(a>0)for(l=0;a>l;l++)p=g[l],r(s,_,null,p,h,c);return r(s,_,null,null,h,c),[b,_,h]}function u(t){if(t&&t[O]("list")){var s,n,e,i;if((e=t.list)&&(n=e.length))if(t.oneOffs>0)for(s=n-1;s>=0;s--)i=e[s],i[1]&&i[4]>0&&(e.splice(s,1),t.oneOffs=t.oneOffs>0?t.oneOffs-1:0);else t.oneOffs=0}return t}function f(t,n,e,i,o){if(e){var p,l,r,f,g,h,b,_,d,m,v,O,y,x,$=c(n,e,i),S=!1;for(_=$[0],v=$[2],y=v.length,$=$[1],r=$.length,x=null,r>0&&(x=new s(t),x.data.data=o,x.originalTopic=_?_.split(j):[]),p=0;r>p;p++){for(d=$[p][0],m=$[p][1],x.topic=d?d.split(j):[],x.tags=m?m.split(w):[],O=$[p][2],h=$[p][3],g=[],f=h.list.length,l=0;f>l;l++)b=h.list[l],b[1]&&b[4]||!(!O||b[2]&&a(b[2],v,y))||g.push(b);for(f=g.length,l=0;f>l&&(b=g[l],x.namespaces=O?b[3].slice(0):[],b[4]=1,S=b[0](x),!1!==S&&!x.stopped()&&!x.aborted());l++);if(u(h),x.aborted()||!x.propagates())break}x&&(x.dispose(),x=null)}}function g(s,n,e){var i=n[0],o=n[2],n=n[1];s.non_local=new t({t:0,s:0,start_topic:!0,subscribers:null,topics:n,namespaces:o,hasNamespace:!1,abort:e}),s.originalTopic=i?i.split(j):[];var p=function(t){var s,n,e,i,o,p=t.non_local;if(p.t<p.topics.length){if(p.start_topic){if(u(p.subscribers),t.aborted()||!t.propagates())return t.aborted()&&"function"==typeof p.abort&&p.abort(t),!1;n=p.topics[p.t][0],e=p.topics[p.t][1],t.topic=n?n.split(j):[],t.tags=e?e.split(w):[],p.hasNamespace=p.topics[p.t][2],p.subscribers=p.topics[p.t][3],p.s=0,p.start_topic=!1}if(p.s<p.subscribers.list.length){if(t.aborted()||t.stopped())return u(p.subscribers),t.aborted()&&"function"==typeof p.abort&&p.abort(t),!1;for(o=!1;p.s<p.subscribers.list.length&&!o;)i=p.subscribers.list[p.s],i[1]&&i[4]||!(!p.hasNamespace||i[2]&&a(i[2],p.namespaces,p.namespaces.length))||(o=!0),p.s+=1;o&&(t.namespaces=p.hasNamespace?i[3].slice(0):[],i[4]=1,s=i[0](t))}p.s>=p.subscribers.list.length&&(p.t+=1,p.start_topic=!0)}else u(p.subscribers),t&&(t.non_local.dispose(),t.non_local=null,t.dispose(),t=null)};return p}function h(t,n,e,i,o,p){if(e){var l,a=c(n,e,i),r=null;a[1].length>0&&(r=new s(t),r.data.data=o,r.pipeline(l=g(r,a,p)),l(r))}}function b(t,s,n,e,o,l){if(s&&"function"==typeof e){n=i(t,n);var a,r,c,u,f,g,h,b=n[1].join(w),_=b.length,d=n[2],m=d.length;if(n=n[0].join(j),o=!0===o,l=!0===l,f={},m)for(h=0;m>h;h++)f["ns_"+d[h]]=1;g=d.slice(0),r=null,n.length?(c="tp_"+n,s.topics[O](c)||(s.topics[c]={notags:{namespaces:{},list:[],oneOffs:0},tags:{}}),_?(u="tg_"+b,s.topics[c].tags[O](u)||(s.topics[c].tags[u]={namespaces:{},list:[],oneOffs:0}),r=s.topics[c].tags[u]):r=s.topics[c].notags):_?(u="tg_"+b,s.notopics.tags[O](u)||(s.notopics.tags[u]={namespaces:{},list:[],oneOffs:0}),r=s.notopics.tags[u]):m&&(r=s.notopics.notags),null!==r&&(a=m?[e,o,f,g,0]:[e,o,!1,[],0],l?r.list.unshift(a):r.list.push(a),o&&r.oneOffs++,m&&p(r.namespaces,d,m))}}function _(t,s,n,e,i){var o,p=t.list.length;if(s){if(null!=n&&p>0)for(;--p>=0;)n===t.list[p][0]&&(i&&t.list[p][2]&&a(t.list[p][2],e,i)?(o=S(t.list[p][2]),l(t.namespaces,o,o.length),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1)):i||(t.list[p][2]&&(o=S(t.list[p][2]),l(t.namespaces,o,o.length)),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1)))}else if(!s&&i>0&&p>0)for(;--p>=0;)t.list[p][2]&&a(t.list[p][2],e,i)&&(o=S(t.list[p][2]),l(t.namespaces,o,o.length),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1));else!s&&p>0&&(t.list=[],t.oneOffs=0,t.namespaces={})}function d(t,s,n,e){if(s){n=i(t,n);var o,p,l,a,r,c,u=n[1].join(w),f=n[2],g=u.length,h=f.length;if(n=n[0].join(j),r=n.length,l=r?"tp_"+n:!1,a=g?"tg_"+u:!1,c=!(!e||"function"!=typeof e),c||(e=null),r&&s.topics[O](l))g&&s.topics[l].tags[O](a)?(_(s.topics[l].tags[a],c,e,f,h),s.topics[l].tags[a].list.length||delete s.topics[l].tags[a]):g||_(s.topics[l].notags,c,e,f,h),s.topics[l].notags.list.length||S(s.topics[l].tags).length||delete s.topics[l];else if(!r&&(g||h))if(g){s.notopics.tags[O](a)&&(_(s.notopics.tags[a],c,e,f,h),s.notopics.tags[a].list.length||delete s.notopics.tags[a]);for(o in s.topics)s.topics[O](o)&&s.topics[o].tags[O](a)&&(_(s.topics[o].tags[a],c,e,f,h),s.topics[o].tags[a].list.length||delete s.topics[o].tags[a])}else{_(s.notopics.notags,c,e,f,h);for(p in s.notopics.tags)s.notopics.tags[O](p)&&(_(s.notopics.tags[p],c,e,f,h),s.notopics.tags[p].list.length||delete s.notopics.tags[p]);for(o in s.topics)if(s.topics[O](o)){_(s.topics[o].notags,c,e,f,h);for(p in s.topics[o].tags)s.topics[o].tags[O](p)&&(_(s.topics[o].tags[p],c,e,f,h),s.topics[o].tags[p].list.length||delete s.topics[o].tags[p])}}}}var m="0.4.1",v="prototype",O="hasOwnProperty",y="/",x="#",$="@",j="/",w="#",S=Object.keys,T=Date.now?Date.now:function(){return(new Date).getTime()};t[v]={constructor:t,dispose:function(t){if(t)for(var s=0;s<t.length;s++)this[t[s]]=null;return this}},s[v]={constructor:s,target:null,topic:null,originalTopic:null,tags:null,namespaces:null,data:null,timestamp:0,is_pipelined:!1,_next:null,_propagates:!0,_stopped:!1,_aborted:!1,dispose:function(){var s=this;return s.target=null,s.topic=null,s.originalTopic=null,s.tags=null,s.namespaces=null,s.data instanceof t&&s.data.dispose(),s.data=null,s.timestamp=null,s.is_pipelined=!1,s._propagates=!0,s._stopped=!0,s._aborted=!1,s._next=null,s},next:function(){return"function"==typeof this._next&&this._next(this),this},pipeline:function(t){return arguments.length||(t=null),"function"==typeof t?(this._next=t,this.is_pipelined=!0):(this._next=null,this.is_pipelined=!1),this},propagate:function(t){return arguments.length||(t=!0),this._propagates=!!t,this},stop:function(t){return arguments.length||(t=!0),this._stopped=!!t,this},abort:function(t){return arguments.length||(t=!0),this._aborted=!!t,this},aborted:function(){return this._aborted},propagates:function(){return this._propagates},stopped:function(){return this._stopped}};var D=function(){return this instanceof D?void this.initPubSub():new D};return D.VERSION=m,D.Event=s,D.Data=function(s){return new t(s)},D[v]={constructor:D,_seps:null,_pubsub$:null,initPubSub:function(){var t=this;return t._seps=[y,x,$],t._pubsub$=n(),t},disposePubSub:function(){var t=this;return t._seps=null,t._pubsub$=null,t},setSeparators:function(t){var s,n=this;return t&&(s=t.length)&&(s>0&&t[0]&&(n._seps[0]=t[0]),s>1&&t[1]&&(n._seps[1]=t[1]),s>2&&t[2]&&(n._seps[2]=t[2])),n},trigger:function(t,s,n){var e=this;return 3>arguments.length&&(n=0),n=+n,s=s||{},n>0?setTimeout(function(){f(e,e._seps,e._pubsub$,t,s)},n):f(e,e._seps,e._pubsub$,t,s),e},pipeline:function(t,s,n,e){var i=this;return 4>arguments.length&&(e=0),e=+e,s=s||{},e>0?setTimeout(function(){h(i,i._seps,i._pubsub$,t,s,n||null)},e):h(i,i._seps,i._pubsub$,t,s,n||null),i},on:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s),n},one:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!0),n},on1:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!1,!0),n},one1:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!0,!0),n},off:function(t,s){var n=this;return d(n._seps,n._pubsub$,t,s||null),n}},D});