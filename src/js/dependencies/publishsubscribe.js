/**
*  PublishSubscribe
*  A simple publish-subscribe implementation for PHP, Python, Node/XPCOM/JS
*
*  @version: 0.4.1
*  https://github.com/foo123/PublishSubscribe
*
**/
!function(t,s,n){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(t.$deps=t.$deps||{})&&(t.EXPORTED_SYMBOLS=[s])&&(t[s]=t.$deps[s]=n.call(t)):"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[s]=n.call(t)):"undefined"!=typeof System&&"function"==typeof System.register&&"function"==typeof System["import"]?System.register(s,[],function(e){e(s,n.call(t))}):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(s)?define(s,["module"],function(s){return n.moduleUri=s.uri,n.call(t)}):s in t||(t[s]=n.call(t)||1)&&"function"==typeof define&&define.amd&&define(function(){return t[s]})}(this,"PublishSubscribe",function(t){"use strict";function s(t){if(t)for(var s in t)t[O](s)&&(this[s]=t[s])}function n(t,n,e,i,o){var p=this;p.target=t,n?p.topic=[].concat(n):p.topic=[],e&&(p.originalTopic=[].concat(e)),i?p.tags=[].concat(i):p.tags=[],o?p.namespaces=[].concat(o):p.namespaces=[],p.data=new s,p.timestamp=D(),p._propagates=!0,p._stopped=!1,p._aborted=!1}function e(){return{notopics:{notags:{namespaces:{},list:[],oneOffs:0},tags:{}},topics:{}}}function i(t){return t.length>0}function o(t,s){var n,e,o,p;return s=String(s),n=s.indexOf(t[2]),e=s.indexOf(t[1]),n>-1?(p=s.slice(n).split(t[2]).filter(i).sort(),s=s.slice(0,n)):p=[],e>-1?(o=s.slice(e).split(t[1]).filter(i).sort(),s=s.slice(0,e)):o=[],s=s.split(t[0]).filter(i),[s,o,p]}function p(t,s){var n,e,i,p,l,a,r,c,u=[],f=[];for(s=o(t,s),n=s[2],e=s[1],s=s[0],i=s.length;i;)u.push(s.join(j)),s.pop(),i--;if(i=e.length,i>1){for(c=1<<i,p=c-1;p>=1;p--){for(r=[],l=0,a=1;i>l;l++,a=1<<l)p!==a&&p&a&&r.push(e[l]);r.length&&f.push(r.join(w))}f=f.concat(e)}else i&&f.push(e[0]);return[u.length?u[0]:"",u,f,n]}function l(t,s,n){var e,i;for(e=0;n>e;e++)i="ns_"+s[e],t[O](i)?t[i]++:t[i]=1}function a(t,s,n){var e,i;for(e=0;n>e;e++)i="ns_"+s[e],t[O](i)&&(t[i]--,t[i]<=0&&delete t[i])}function r(t,s,n){var e,i;for(e=0;n>e;e++)if(i="ns_"+s[e],!t[O](i)||0>=t[i])return!1;return!0}function c(t,s,n,e,i,o){var p=n?"tp_"+n:!1,l=e?"tg_"+e:!1;if(p&&t.topics[O](p)){if(l&&t.topics[p].tags[O](l)){if(t.topics[p].tags[l].list.length&&(0>=o||r(t.topics[p].tags[l].namespaces,i,o)))return s.push([n,e,o>0,t.topics[p].tags[l]]),!0}else if(t.topics[p].notags.list.length&&(0>=o||r(t.topics[p].notags.namespaces,i,o)))return s.push([n,null,o>0,t.topics[p].notags]),!0}else if(l&&t.notopics.tags[O](l)){if(t.notopics.tags[l].list.length&&(0>=o||r(t.notopics.tags[l].namespaces,i,o)))return s.push([null,e,o>0,t.notopics.tags[l]]),!0}else if(t.notopics.notags.list.length&&(0>=o||r(t.notopics.notags.namespaces,i,o)))return s.push([null,null,!0,t.notopics.notags]),!0;return!1}function u(t,s,n){var e,i,o,l,a,r,u=p(t,n),f=u[1],g=u[2],h=u[3],d=u[0],b=[];if(a=g.length,r=h.length,e=f.length)for(;e;){if(i=f[0],s.topics[O]("tp_"+i))if(a>0)for(l=0;a>l;l++)o=g[l],c(s,b,i,o,h,r);else c(s,b,i,null,h,r);f.shift(),e--}if(a>0)for(l=0;a>l;l++)o=g[l],c(s,b,null,o,h,r);return c(s,b,null,null,h,r),[d,b,h]}function f(t){if(t&&t[O]("list")){var s,n,e,i;if((e=t.list)&&(n=e.length))if(t.oneOffs>0)for(s=n-1;s>=0;s--)i=e[s],i[1]&&i[4]>0&&(e.splice(s,1),t.oneOffs=t.oneOffs>0?t.oneOffs-1:0);else t.oneOffs=0}return t}function g(t,s,e,i,o){if(e){var p,l,a,c,g,h,d,b,_,m,v,y,O,$,S=u(s,e,i),x=!1;for(b=S[0],v=S[2],O=v.length,S=S[1],a=S.length,$=null,a>0&&($=new n(t),$.data.data=o,$.originalTopic=b?b.split(j):[]),p=0;a>p;p++){for(_=S[p][0],m=S[p][1],$.topic=_?_.split(j):[],$.tags=m?m.split(w):[],y=S[p][2],h=S[p][3],g=[],c=h.list.length,l=0;c>l;l++)d=h.list[l],d[1]&&d[4]||!(!y||d[2]&&r(d[2],v,O))||g.push(d);for(c=g.length,l=0;c>l&&(d=g[l],y?$.namespaces=d[3].slice(0):$.namespaces=[],d[4]=1,x=d[0]($),!1!==x&&!$.stopped()&&!$.aborted());l++);if(f(h),$.aborted()||!$.propagates())break}$&&($.dispose(),$=null)}}function h(t,n,e){var i=n[0],o=n[2],n=n[1];t.non_local=new s({t:0,s:0,start_topic:!0,subscribers:null,topics:n,namespaces:o,hasNamespace:!1,abort:e}),t.originalTopic=i?i.split(j):[];var p=function(t){var s,n,e,i,o,p=t.non_local;if(p.t<p.topics.length){if(p.start_topic){if(f(p.subscribers),t.aborted()||!t.propagates())return t.aborted()&&"function"==typeof p.abort&&p.abort(t),!1;n=p.topics[p.t][0],e=p.topics[p.t][1],t.topic=n?n.split(j):[],t.tags=e?e.split(w):[],p.hasNamespace=p.topics[p.t][2],p.subscribers=p.topics[p.t][3],p.s=0,p.start_topic=!1}if(p.s<p.subscribers.list.length){if(t.aborted()||t.stopped())return f(p.subscribers),t.aborted()&&"function"==typeof p.abort&&p.abort(t),!1;for(o=!1;p.s<p.subscribers.list.length&&!o;)i=p.subscribers.list[p.s],i[1]&&i[4]||!(!p.hasNamespace||i[2]&&r(i[2],p.namespaces,p.namespaces.length))||(o=!0),p.s+=1;o&&(p.hasNamespace?t.namespaces=i[3].slice(0):t.namespaces=[],i[4]=1,s=i[0](t))}p.s>=p.subscribers.list.length&&(p.t+=1,p.start_topic=!0)}else f(p.subscribers),t&&(t.non_local.dispose(),t.non_local=null,t.dispose(),t=null)};return p}function d(t,s,e,i,o,p){if(e){var l,a=u(s,e,i),r=null;a[1].length>0&&(r=new n(t),r.data.data=o,r.pipeline(l=h(r,a,p)),l(r))}}function b(t,s,n,e,i,p){if(s&&"function"==typeof e){n=o(t,n);var a,r,c,u,f,g,h,d=n[1].join(w),b=d.length,_=n[2],m=_.length;if(n=n[0].join(j),i=!0===i,p=!0===p,f={},m)for(h=0;m>h;h++)f["ns_"+_[h]]=1;g=_.slice(0),r=null,n.length?(c="tp_"+n,s.topics[O](c)||(s.topics[c]={notags:{namespaces:{},list:[],oneOffs:0},tags:{}}),b?(u="tg_"+d,s.topics[c].tags[O](u)||(s.topics[c].tags[u]={namespaces:{},list:[],oneOffs:0}),r=s.topics[c].tags[u]):r=s.topics[c].notags):b?(u="tg_"+d,s.notopics.tags[O](u)||(s.notopics.tags[u]={namespaces:{},list:[],oneOffs:0}),r=s.notopics.tags[u]):m&&(r=s.notopics.notags),null!==r&&(a=m?[e,i,f,g,0]:[e,i,!1,[],0],p?r.list.unshift(a):r.list.push(a),i&&r.oneOffs++,m&&l(r.namespaces,_,m))}}function _(t,s,n,e,i){var o,p=t.list.length;if(s){if(null!=n&&p>0)for(;--p>=0;)n===t.list[p][0]&&(i&&t.list[p][2]&&r(t.list[p][2],e,i)?(o=T(t.list[p][2]),a(t.namespaces,o,o.length),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1)):i||(t.list[p][2]&&(o=T(t.list[p][2]),a(t.namespaces,o,o.length)),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1)))}else if(!s&&i>0&&p>0)for(;--p>=0;)t.list[p][2]&&r(t.list[p][2],e,i)&&(o=T(t.list[p][2]),a(t.namespaces,o,o.length),t.list[p][1]&&(t.oneOffs=t.oneOffs>0?t.oneOffs-1:0),t.list.splice(p,1));else!s&&p>0&&(t.list=[],t.oneOffs=0,t.namespaces={})}function m(t,s,n,e){if(s){n=o(t,n);var i,p,l,a,r,c,u=n[1].join(w),f=n[2],g=u.length,h=f.length;if(n=n[0].join(j),r=n.length,l=r?"tp_"+n:!1,a=g?"tg_"+u:!1,c=!(!e||"function"!=typeof e),c||(e=null),r&&s.topics[O](l))g&&s.topics[l].tags[O](a)?(_(s.topics[l].tags[a],c,e,f,h),s.topics[l].tags[a].list.length||delete s.topics[l].tags[a]):g||_(s.topics[l].notags,c,e,f,h),s.topics[l].notags.list.length||T(s.topics[l].tags).length||delete s.topics[l];else if(!r&&(g||h))if(g){s.notopics.tags[O](a)&&(_(s.notopics.tags[a],c,e,f,h),s.notopics.tags[a].list.length||delete s.notopics.tags[a]);for(i in s.topics)s.topics[O](i)&&s.topics[i].tags[O](a)&&(_(s.topics[i].tags[a],c,e,f,h),s.topics[i].tags[a].list.length||delete s.topics[i].tags[a])}else{_(s.notopics.notags,c,e,f,h);for(p in s.notopics.tags)s.notopics.tags[O](p)&&(_(s.notopics.tags[p],c,e,f,h),s.notopics.tags[p].list.length||delete s.notopics.tags[p]);for(i in s.topics)if(s.topics[O](i)){_(s.topics[i].notags,c,e,f,h);for(p in s.topics[i].tags)s.topics[i].tags[O](p)&&(_(s.topics[i].tags[p],c,e,f,h),s.topics[i].tags[p].list.length||delete s.topics[i].tags[p])}}}}var v="0.4.1",y="prototype",O="hasOwnProperty",$="/",S="#",x="@",j="/",w="#",T=Object.keys,D=Date.now?Date.now:function(){return(new Date).getTime()};s[y]={constructor:s,dispose:function(t){if(t)for(var s=0;s<t.length;s++)this[t[s]]=null;return this}},n[y]={constructor:n,target:null,topic:null,originalTopic:null,tags:null,namespaces:null,data:null,timestamp:0,is_pipelined:!1,_next:null,_propagates:!0,_stopped:!1,_aborted:!1,dispose:function(){var t=this;return t.target=null,t.topic=null,t.originalTopic=null,t.tags=null,t.namespaces=null,t.data instanceof s&&t.data.dispose(),t.data=null,t.timestamp=null,t.is_pipelined=!1,t._propagates=!0,t._stopped=!0,t._aborted=!1,t._next=null,t},next:function(){return"function"==typeof this._next&&this._next(this),this},pipeline:function(t){return arguments.length||(t=null),"function"==typeof t?(this._next=t,this.is_pipelined=!0):(this._next=null,this.is_pipelined=!1),this},propagate:function(t){return arguments.length||(t=!0),this._propagates=!!t,this},stop:function(t){return arguments.length||(t=!0),this._stopped=!!t,this},abort:function(t){return arguments.length||(t=!0),this._aborted=!!t,this},aborted:function(){return this._aborted},propagates:function(){return this._propagates},stopped:function(){return this._stopped}};var P=function(){return this instanceof P?void this.initPubSub():new P};return P.VERSION=v,P.Event=n,P.Data=function(t){return new s(t)},P[y]={constructor:P,_seps:null,_pubsub$:null,initPubSub:function(){var t=this;return t._seps=[$,S,x],t._pubsub$=e(),t},disposePubSub:function(){var t=this;return t._seps=null,t._pubsub$=null,t},setSeparators:function(t){var s,n=this;return t&&(s=t.length)&&(s>0&&t[0]&&(n._seps[0]=t[0]),s>1&&t[1]&&(n._seps[1]=t[1]),s>2&&t[2]&&(n._seps[2]=t[2])),n},trigger:function(t,s,n){var e=this;return 3>arguments.length&&(n=0),n=+n,s=s||{},n>0?setTimeout(function(){g(e,e._seps,e._pubsub$,t,s)},n):g(e,e._seps,e._pubsub$,t,s),e},pipeline:function(t,s,n,e){var i=this;return 4>arguments.length&&(e=0),e=+e,s=s||{},e>0?setTimeout(function(){d(i,i._seps,i._pubsub$,t,s,n||null)},e):d(i,i._seps,i._pubsub$,t,s,n||null),i},on:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s),n},one:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!0),n},on1:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!1,!0),n},one1:function(t,s){var n=this;return s&&"function"==typeof s&&b(n._seps,n._pubsub$,t,s,!0,!0),n},off:function(t,s){var n=this;return m(n._seps,n._pubsub$,t,s||null),n}},P});